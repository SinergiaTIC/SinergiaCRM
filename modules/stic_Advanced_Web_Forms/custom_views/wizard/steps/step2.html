<!-- Sidebar -->
<!--       data-attribute="x-on:change='treeToggleAllModules(step2.treeShowAllModules)'" -->
<nav class="wizard-sidebar bg-light border-end p-2 flex-shrink-0">
  <h3 x-text="translate('LBL_RELATIONSHIPS')"></h3>
  <div
    class="text-muted form-check form-switch"
    id="switch_TreeAllModules"
    data-model="step2.treeShowAllModules"
    data-label="LBL_SHOW_ALL_MODULES"
    data-attribute="x-on:change='treeToggleAllModules(step2.treeShowAllModules)'"
    x-init="sticControls.fieldCheckbox($el);"
  ></div>
  <div id="jstree-loading" style="display: flex; justify-content: center; align-items: center; height: 200px">
    <div class="spinner-border text-secondary" role="status"></div>
  </div>
  <div
    class="wizard-tree"
    id="jstree-container"
    x-init="$nextTick(() => {initializeModuleTree($('#jstree-container'));});"
    style="display: none"
  ></div>
</nav>

<!-- Main Panel -->
<main class="wizard-main flex-fill d-flex flex-column p-3">
  <h3 class="mb-2" x-text="translate('LBL_DATABLOCKS')"></h3>
  <div class="flex-fill border rounded p-2 bg-white">
    <!-- Main Content -->
    <template x-for="(item, key) in formConfig.data_blocks">
      <div class="card" :x-data="{item: item, key: key}">
        <div class="card-body">
          <div class="card-title">
            <div class="d-flex justify-content-between">
              <h4
                :id="'dataBlockTitleEdit-'+item.name"
                data-model="item.text"
                data-condition="item.editable_text"
                x-init="sticControls.editableText($el);"
              ></h4>
              <template x-if="'required' in item && typeof item.required === 'function' && !item.required()">
                <span class="btn suitepicon suitepicon-action-delete" @click="deleteDataBlock(key);"></span>
              </template>
            </div>
            <template x-if="item.module">
              <h5 class="text-muted" x-text="getModuleInformation(item.module).text + ' (' + item.name + ')'"></h5>
            </template>
          </div>

          <div class="card-text">
            <!-- Fields Definition -->
            <div :id="'dataBlockFields'+item.name">
              [Los campos del Bloque de datos]
              <!-- Fields Details -->
              <div x-data="{ showDataFieldsTable: false}">
                <div
                  class="text-muted form-check form-switch mt-3"
                  :id="'dataFieldsDetails'+item.name"
                  data-model="showDataFieldsTable"
                  data-label-text="[Mostrar Detalle]"
                  x-init="sticControls.fieldCheckbox($el);"
                ></div>
                <div class="card p-2 overflow-auto" x-show="showDataFieldsTable">
                  <div
                    class="mt-3"
                    :id="'dataFieldsTable'+item.name"
                    :data-objects="'item.fields'"
                    x-init="sticControls.elemTableObjects($el);"
                  ></div>
                </div>
              </div>
            </div>
            <template x-if="item.module">
              <!-- Duplicate Definition -->
              <div :id="'dataBlockDuplicates'+item.name">
                <div class="row">
                  <!-- Action -->
                  <div
                    class="col-3"
                    :id="'duplicateAction'+item.name"
                    :data-model="'item.duplicate_detection.on_duplicate'"
                    data-label="LBL_ONDUPLICATE_ACTION"
                    data-map="appListStrings.stic_advanced_web_forms_datablocks_duplicate_action_list"
                    x-init="sticControls.fieldSelect($el)"
                  ></div>
                  <!-- Fields -->
                  <div
                    class="col-9"
                    :id="'duplicateFields'+item.name"
                    :data-model="'item.duplicate_detection.fields'"
                    data-label="LBL_DUPLICATE_FIELDS"
                    :data-map="`getModuleInformation('${item.module}').fields`"
                    data-map-property="text"
                    data-multiple
                    x-init="sticControls.fieldSelect($el)"
                  ></div>
                </div>
                <!-- Duplicate Details -->
                <div x-data="{ showDataDuplicateTable: false}">
                  <div
                    class="text-muted form-check form-switch mt-3"
                    :id="'dataDuplicateDetails'+item.name"
                    data-model="showDataDuplicateTable"
                    data-label-text="[Mostrar Detalle]"
                    x-init="sticControls.fieldCheckbox($el);"
                  ></div>
                  <div class="card p-2 overflow-auto" x-show="showDataDuplicateTable">
                    <div
                      class="mt-3"
                      :id="'dataDuplicateTable'+item.name"
                      :data-model="'item.duplicate_detection'"
                      x-init="sticControls.elemTableObject($el);"
                    ></div>
                  </div>
                </div>
              </div>
            </template>

            <!-- Accordion Headers -->
            <template x-if="item.module">
              <div
                :id="'dataDef_'+item.name"
                :data-sections="JSON.stringify([
                                    {headerText:`translate('LBL_FIELDS') + ' ('+item.fields.length+')'`, selected:true, contentId:'dataBlockFields'+item.name},
                                    {headerText:`translate('LBL_DUPLICATE_CHECK') + ' ('+item.duplicate_detection.fields.length+' - '+item.duplicate_detection.on_duplicate+')'`, selected:false, contentId:'dataBlockDuplicates'+item.name}
                                  ]);"
                x-init="sticControls.accordion($el)"
              ></div>
            </template>
            <template x-if="!item.module">
              <div
                :id="'dataDef_'+item.name"
                :data-sections="JSON.stringify([
                                    {headerText:`translate('LBL_FIELDS') + ' (' + item.fields.length +')'`, selected:true, contentId:'dataBlockFields'+item.name},
                                  ]);"
                x-init="sticControls.accordion($el)"
              ></div>
            </template>
          </div>
        </div>
      </div>
    </template>

    <!-- Details Data [DEBUG] -->
    <div x-data="{ showDetails: false}">
      <div
        class="text-muted form-check form-switch mb-3 mt-5"
        id="showDetailsDataToggleSwitch"
        data-model="showDetails"
        data-label-text="[Mostrar Detalles]"
        x-init="sticControls.fieldCheckbox($el);"
      ></div>
      <div class="card p-2" x-show="showDetails">
        <!-- Relationships in Data Blocks -->
        <div id="detailsRelDataBlocks">
          <div
            class="mt-3"
            id="relDataBlocksTable"
            data-model="step2.relationshipsInDataBlocks"
            x-init="sticControls.elemTableArray($el);"
          ></div>
        </div>

        <!-- Modules in Data Blocks -->
        <div id="detailsModulesDataBlocks">
          <div
            class="mt-3"
            id="modulesDataBlocksTable"
            data-model="step2.modulesInDataBlocks"
            x-init="sticControls.elemTableArray($el);"
          ></div>
        </div>

        <!-- Data Blocks -->
        <div id="detailsDataBlocks">
          <div
            class="mt-3"
            id="dataBlocksTable"
            data-objects="formConfig.data_blocks"
            x-init="sticControls.elemTableObjects($el);"
          ></div>
        </div>

        <!-- Selected Node -->
        <div id="detailsNode">
          <h3 class="card-title" x-text="step2.treeSelectedRelatedModule.pathText?.join(' » ')"></h3>
          <!-- General Data -->
          <div id="detailsNodeGeneralData">
            <h4 class="card-title mb-4" x-text="step2.treeSelectedRelatedModule.name + ' - General Data'"></h4>
            <template x-for="(value, key) in step2.treeSelectedRelatedModule">
              <template x-if="key!='fields' && key!='relationships'">
                <template x-if="value!=''">
                  <p x-text="key + ': ' + value"></p>
                </template>
              </template>
            </template>
          </div>
          <!-- Fields -->
          <div id="detailsNodeFields" x-data="{ hideNotInView: false, hideNotRequired: false}">
            <h4
              class="card-title mb-4"
              x-text="(step2.treeSelectedRelatedModule.isRelation?step2.treeSelectedRelatedModule.moduleDestName:step2.treeSelectedRelatedModule.name) + ' - Fields'"
            ></h4>
            <div
              class="form-check form-switch form-check-inline"
              id="detailsFieldsInViewToggleSwitch"
              data-model="hideNotInView"
              data-label-text="[Ocultar no in View]"
              x-init="sticControls.fieldCheckbox($el);"
            ></div>
            <div
              class="form-check form-switch form-check-inline"
              id="detailsFieldsRequiredToggleSwitch"
              data-model="hideNotRequired"
              data-label-text="[Ocultar no required]"
              x-init="sticControls.fieldCheckbox($el);"
            ></div>
            <div
              class="mt-3"
              id="detailsFieldsTable"
              data-objects="step2.treeSelectedRelatedModule.fields"
              data-show-row="(!hideNotRequired || step2.treeSelectedRelatedModule.fields[key].required) && (!hideNotInView || step2.treeSelectedRelatedModule.fields[key].inViews)"
              x-init="sticControls.elemTableObjects($el);"
            ></div>
          </div>
          <!-- Relationships -->
          <div id="detailsNodeRelationships">
            <h4
              class="card-title mb-4"
              x-text="(step2.treeSelectedRelatedModule.isRelation?step2.treeSelectedRelatedModule.moduleDestName:step2.treeSelectedRelatedModule.name) + ' - Relationships'"
            ></h4>
            <div
              class="mt-3"
              id="detailsRelationshipsTable"
              data-objects="step2.treeSelectedRelatedModule.relationships"
              x-init="sticControls.elemTableObjects($el);"
            ></div>
          </div>

          <!-- Tab Headers -->
          <div
            id="detailsNode"
            :data-sections="JSON.stringify([
                          {headerText:`'[Datos Generales]'`, selected:true, contentId:'detailsNodeGeneralData'},
                          {headerText:`'[Campos]'`, selected:false, contentId:'detailsNodeFields'},
                          {headerText:`'[Relaciones]'`, selected:false, contentId:'detailsNodeRelationships'},
                        ]);"
            x-init="sticControls.tabs($el)"
          ></div>
        </div>

        <!-- Tab Headers -->
        <div
          id="details"
          :data-sections="JSON.stringify([
                          {headerText:`'[Relaciones en Bloques de datos]'`, selected:true, contentId:'detailsRelDataBlocks'},
                          {headerText:`'[Módulos en Bloques de datos]'`, selected:false, contentId:'detailsModulesDataBlocks'},
                          {headerText:`'[Bloques de datos]'`, selected:false, contentId:'detailsDataBlocks'},
                          {headerText:`'[Nodo seleccionado]'`, selected:false, contentId:'detailsNode'},
                        ]);"
          x-init="sticControls.tabs($el)"
        ></div>
      </div>
    </div>
  </div>
</main>
