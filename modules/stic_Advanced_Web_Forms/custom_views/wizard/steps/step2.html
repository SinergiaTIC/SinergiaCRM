<!-- Main Panel -->
<main class="wizard-main flex-fill d-flex flex-column">
  <!-- Add DataBlock from Module -->
  <div
    class="border-bottom ps-3 pt-3 mb-2 bg-light"
    x-data="{creatingDataBlock:!formConfig.data_blocks.some(b => b.module!=''), newDataBlock:{module:'', text:''}}"
  >
    <div class="row">
      <button type="button" class="btn w-auto" x-show="!creatingDataBlock" @click="creatingDataBlock=true;">
        [Añadir Bloque de Datos de Módulo]
      </button>
      <h4 x-show="creatingDataBlock">[Añadir Bloque de Datos de Módulo]</h4>
    </div>
    <div class="row align-items-end" x-show="creatingDataBlock">
      <!-- Module -->
      <stic-field-select
        class="col-3"
        x-model="newDataBlock.module"
        label="LBL_MODULE"
        map="STIC.enabledModules"
        map-text="text"
      ></stic-field-select>
      <!-- Data Block name -->
      <stic-field-text
        class="col-3"
        x-model="newDataBlock.text"
        label="LBL_DATABLOCK"
        x-effect="newDataBlock.text=formConfig.suggestDataBlockName(newDataBlock.module)"
        keydown.enter="$('#addDataBlockModuleButton').click();"
        keydown.esc="$('#cancelAddDataBlockModuleButton').click();"
      ></stic-field-text>
      <button
        type="button"
        class="btn w-32px mb-1px"
        id="addDataBlockModuleButton"
        @click="formConfig.addDataBlockModule(newDataBlock.module, true, newDataBlock.text); creatingDataBlock = false;"
      >
        <span class="suitepicon suitepicon-action-confirm"></span>
      </button>
      <button
        type="button"
        class="btn w-32px mb-1px"
        id="cancelAddDataBlockModuleButton"
        @click="creatingDataBlock = false;"
      >
        <span class="suitepicon suitepicon-action-clear"></span>
      </button>
    </div>
  </div>
  <!-- Data Blocks -->
  <div>
    <h3 class="mb-2" x-text="utils.translate('LBL_DATABLOCKS')+':'"></h3>
    <div class="flex-fill border rounded p-2 overflow-auto" x-data ="{
      createRelDataBlock(itemId){
        DataBlockEditor.addRelationDataBlockEditor($('#dataBlockRelsEdit' + itemId), itemId);
      }
    }">
      <!-- Main Content -->
      <template x-for="(item, key) in formConfig.data_blocks">
        <div class="card" :x-data="{item: item, key: key}">
          <div class="card-body">
            <div class="card-title">
              <div class="d-flex justify-content-between">
                <h4
                  :id="'dataBlockTitleEdit-'+item.id"
                  data-model="item.text"
                  data-condition="item.editable_text"
                  x-init="sticControls.editableText($el);"
                ></h4>
                <template x-if="'required' in item && typeof item.required === 'function' && !item.required()">
                  <span class="btn suitepicon suitepicon-action-delete" @click="deleteDataBlock(key);"></span>
                </template>
              </div>
              <template x-if="item.module">
                <h5
                  class="text-muted"
                  x-text="utils.getModuleInformation(item.module).text + ' (' + item.id + ')'"
                ></h5>
              </template>
            </div>

            <div class="card-text">
              <!-- Fields Definition -->
              <div :id="'dataBlockFields'+item.id">
                [Los campos del Bloque de datos]
                <!-- Fields Details -->
                <div x-data="{ showDataFieldsTable: false}">
                  <div
                    class="text-muted form-check form-switch mt-3"
                    :id="'dataFieldsDetails'+item.name"
                    data-model="showDataFieldsTable"
                    data-label-text="[Mostrar Detalle]"
                    x-init="sticControls.fieldCheckbox($el);"
                  ></div>
                  <div class="card p-2 overflow-auto" x-show="showDataFieldsTable">
                    <div
                      class="mt-3"
                      :id="'dataFieldsTable'+item.id"
                      :data-objects="'item.fields'"
                      x-init="sticControls.elemTableObjects($el);"
                    ></div>
                  </div>
                </div>
                <div x-effect="item.checkDataBlock()"></div>
              </div>
              <!-- Duplicate Definition -->
              <template x-if="item.module">
                <div :id="'dataBlockDuplicates'+item.id">
                  <div class="row">
                    <!-- Action -->
                    <div
                      class="col-3"
                      :id="'duplicateAction'+item.id"
                      :data-model="'item.duplicate_detection.on_duplicate'"
                      data-label="LBL_ONDUPLICATE_ACTION"
                      :data-map="utils.getList('stic_advanced_web_forms_datablocks_duplicate_action_list', true)"
                      x-init="sticControls.fieldSelect($el)"
                    ></div>
                    <!-- Fields -->
                    <div
                      class="col-9"
                      :id="'duplicateFields'+item.id"
                      :data-model="'item.duplicate_detection.fields'"
                      data-label="LBL_DUPLICATE_FIELDS"
                      :data-mapOld="`item.fields`"
                      data-map-propertyOld="label"
                      data-map-valueOld="name"
                      :data-map="`utils.getModuleInformation('${item.module}').fields`"
                      data-map-property="text"
                      data-multiple
                      x-init="sticControls.fieldSelect($el)"
                    ></div>
                  </div>
                </div>
              </template>
              <!-- Relationship Definition -->
              <template x-if="item.module">
                <div :id="'dataBlockRels'+item.id">
                  [Las relaciones del Bloque de datos]
                  <!-- Relationship Details -->
                  <div
                    class="border-bottom ps-3 pt-3 mb-2 bg-light"
                    x-data="{creatingRelDataBlock:false, relationshipName:'', newDataBlock:{module:'', text:''}}"
                  >
                    <div class="row">
                      <!-- <button
                        type="button"
                        class="btn w-auto"
                        x-show="!creatingRelDataBlock"
                        @click="creatingRelDataBlock=true;"
                      >
                        [Añadir Relación con otro Bloque de Datos]
                      </button> -->
                      <button
                      type="button"
                      class="btn w-auto"
                      x-show="!creatingRelDataBlock"
                      @click="creatingRelDataBlock=true; createRelDataBlock(item.id);"
                    >
                      [Añadir Relación con otro Bloque de Datos]
                    </button>
                      <h4 x-show="creatingRelDataBlock">[Añadir Relación con otro Bloque de Datos]</h4>
                    </div>
                    <div :id="'dataBlockRelsEdit'+item.id" class="row align-items-end" x-show="creatingRelDataBlock">
                      <!-- Relationship -->
                      <!-- <div
                        class="col-3"
                        :id="'dataBlockRels'+item.id+'New_SelRel'"
                        data-model="relationshipName"
                        data-label="LBL_RELATIONSHIP"
                        :data-map="`formConfig.getAvailableRelationships('${item.id}')`"
                        data-map-property="textExtended"
                        data-map-value="name"
                        x-init="sticControls.fieldSelect($el)"
                      ></div> -->
                      <!-- Data Blocks -->
                      <!-- <div
                        class="col-3"
                        :id="'dataBlockRels'+item.id+'New_SelDb'"
                        data-model="newDataBlock"
                        data-label="[Escoger Bloque de datos]"
                        :data-map="`formConfig.getAvailableDataBlocksForRelationship('${item.id}', relationshipName)`"
                        data-map-property="text"
                        data-map-value="id"
                        x-init="sticControls.fieldSelect($el)"
                      ></div> -->
                      <!-- <div
                        class="col-3"
                        :id="'dataBlockRels'+item.id+'New_DbName'"
                        data-model="newDataBlock.text"
                        data-label="[Nuevo Bloque de datos]"
                        data-attribute="x-effect='newRelatedDataBlock.text=formConfig.suggestDataBlockName(newDataBlock.module)'"
                        x-init="sticControls.fieldText($el)"
                      ></div> -->
                      <!-- <button
                        type="button"
                        class="btn w-32px mb-1px"
                        @click="formConfig.addDataBlockModule(newRelatedDataBlock.module, true, newRelatedDataBlock.text); creatingRelDataBlock = false;"
                      >
                        <span class="suitepicon suitepicon-action-confirm"></span>
                      </button>
                      <button type="button" class="btn w-32px mb-1px" @click="creatingRelDataBlock = false;">
                        <span class="suitepicon suitepicon-action-clear"></span>
                      </button> -->
                    </div>
                  </div>
                </div>
              </template>

              <!-- Accordion Headers -->
              <template x-if="item.module">
                <div
                  :id="'dataDef_'+item.id"
                  :data-sections="JSON.stringify([
                                    {headerText:`utils.translate('LBL_FIELDS') + ' ('+item.fields.length+')'`, selected:true, contentId:'dataBlockFields'+item.id},
                                    {headerText:`utils.translate('LBL_DUPLICATE_CHECK') + ' ('+item.duplicate_detection.fields.length+' - '+item.duplicate_detection.on_duplicate+')'`, selected:false, contentId:'dataBlockDuplicates'+item.id},
                                    {headerText:`utils.translate('LBL_RELATIONSHIPS')`, selected:false, contentId:'dataBlockRels'+item.id},
                                  ]);"
                  x-init="sticControls.accordion($el)"
                ></div>
              </template>
              <template x-if="!item.module">
                <div
                  :id="'dataDef_'+item.id"
                  :data-sections="JSON.stringify([
                                    {headerText:`utils.translate('LBL_FIELDS') + ' (' + item.fields.length +')'`, selected:true, contentId:'dataBlockFields'+item.id},
                                  ]);"
                  x-init="sticControls.accordion($el)"
                ></div>
              </template>
            </div>
          </div>
        </div>
      </template>
    </div>
  </div>
  <!-- Details Data [DEBUG] -->
  <div x-data="{ showDetails: false}">
    <div
      class="text-muted form-check form-switch mb-3 mt-5"
      id="showDetailsDataToggleSwitch"
      data-model="showDetails"
      data-label-text="[Mostrar Detalles]"
      x-init="sticControls.fieldCheckbox($el);"
    ></div>
    <div class="card p-2" x-show="showDetails">
      <!-- Data Blocks -->
      <div id="detailsDataBlocks">
        <div
          class="mt-3"
          id="dataBlocksTable"
          data-objects="formConfig.data_blocks"
          x-init="sticControls.elemTableObjects($el);"
        ></div>
      </div>
      <!-- Tab Headers -->
      <div
        id="details"
        :data-sections="JSON.stringify([
                              {headerText:`'[Bloques de datos]'`, selected:true, contentId:'detailsDataBlocks'},
                            ]);"
        x-init="sticControls.tabs($el)"
      ></div>
    </div>
  </div>
</main>
