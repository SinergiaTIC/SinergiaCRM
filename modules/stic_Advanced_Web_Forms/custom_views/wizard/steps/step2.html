<!-- Main Panel -->
<main class="wizard-main flex-fill d-flex flex-column">
  <!-- Add DataBlock from Module -->
  <div
    class="border-bottom ps-3 pt-3 mb-2 bg-light"
    x-data="{
      creatingDataBlock: !formConfig.data_blocks.some(b => b.module!=''), 
      newDataBlock: {module:'', text:''},
      async handleAddDatablockModule() {
        formConfig.addDataBlockModule(this.newDataBlock.module, true, this.newDataBlock.text);
        this.creatingDataBlock = false;
        step2.loadDatablockRelationships();
      },
    }">
    <div class="row">
      <button type="button" class="btn w-auto" x-show="!creatingDataBlock" @click="creatingDataBlock=true;">
        [Añadir Bloque de Datos de Módulo]
      </button>
      <h4 x-show="creatingDataBlock">[Añadir Bloque de Datos de Módulo]</h4>
    </div>
    <div class="row align-items-end" x-show="creatingDataBlock">
      <!-- Module -->
      <stic-field-select class="col-3" x-model="newDataBlock.module" label="LBL_MODULE" map="STIC.enabledModules" map-text="text"></stic-field-select>
      <!-- Data Block name -->
      <stic-field-text class="col-3" x-model="newDataBlock.text" label="LBL_NEW_DATABLOCK_NAME" 
                       x-effect="newDataBlock.text=formConfig.suggestDataBlockText(newDataBlock.module)" 
                       keydown.enter="$('#addDataBlockModuleButton').click();" 
                       keydown.esc="$('#cancelAddDataBlockModuleButton').click();"></stic-field-text>
      <button type="button" class="btn w-32px mb-1px" id="addDataBlockModuleButton" @click="handleAddDatablockModule();">
        <span class="suitepicon suitepicon-action-confirm"></span>
      </button>
      <button type="button" class="btn w-32px mb-1px" id="cancelAddDataBlockModuleButton" @click="creatingDataBlock = false;">
        <span class="suitepicon suitepicon-action-clear"></span>
      </button>
    </div>
  </div>
  <!-- Data Blocks -->
  <div x-init="step2.loadDatablockRelationships();">
    <h2 class="mb-2" x-text="utils.translate('LBL_DATABLOCKS')"></h2>
    <div class="flex-fill border rounded p-2 overflow-auto">
      <!-- Main Content -->
      <template x-for="(item, key) in formConfig.data_blocks">
        <div class="card datablock">
          <!-- DataBlock header -->
          <div class="card-header d-flex flex-column">
            <template x-if="item.module">
              <div class="d-flex justify-content-start datablock-module"> 
                <span class="mb-0 text-muted small" x-text="item.getTextDescription()"></span>
              </div>
            </template>
            <div class="d-flex justify-content-between align-items-center">
              <h3 class="mb-0 me-3" :id="`dataBlockTitleEdit-${item.id}`" data-model="item.text" data-condition="item.editable_text" 
                  x-init="sticControls.editableText($el);"></h3>
              <span class="btn suitepicon suitepicon-action-delete" x-show="!item.required" @click="deleteDataBlock(key);"></span>
            </div>
          </div>
          <!-- DataBlock body -->
          <div class="card-body">
            <!-- Fields Definition -->
            <div :id="`dataBlockFields${item.id}`">
              [Los campos del Bloque de datos]
              <!-- Fields Details -->
              <div x-data="{ showDataFieldsTable: false}">
                <div class="text-muted form-check form-switch mt-3" :id="`dataFieldsDetails${item.id}`" 
                      data-model="showDataFieldsTable" data-label-text="[Mostrar Detalles]" x-init="sticControls.fieldCheckbox($el);"></div>
                <div class="card p-2 overflow-auto" x-show="showDataFieldsTable">
                  <div class="mt-3" :id="`dataFieldsTable${item.id}`" :data-objects="'item.fields'" x-init="sticControls.elemTableObjects($el);"></div>
                </div>
              </div>
              <div x-effect="item.checkDataBlock()"></div>
              <!-- Add Field -->
              <div class="border-bottom ps-3 pt-3 mb-2 bg-light" x-data="{
                creatingField: false, 
                showAllFields: false,
                availableFields: [],
                newField: new AWF_Field(),
                availableValueTypes: [],
                availableTypesInForm: [],
                mustInForm: false,
                fixedValue:false,
                fixedValueOfOptions: false,
                fixedType: 'text',

                async loadFields() {
                  this.reloadFields();
                  this.creatingField = !this.creatingField;
                },
                async reloadFields() {
                  this.newField = new AWF_Field();

                  if (this.showAllFields) {
                    this.availableFields = item.getAvailableFieldsInformation();
                  } else {
                    this.availableFields = (item.getAvailableFieldsInformation().filter(f => f.inViews));
                  }
                  this.newField.name = this.availableFields[0]?.name;
                  this.handleFieldChange();
                },
                async handleFieldChange(){
                  let selectedFieldInfo = this.availableFields.find(f => f.name == this.newField.name);
                  this.newField.updateWithFieldInformation(selectedFieldInfo);
                  this.availableValueTypes = this.newField.getAvailableValueTypes();
                  this.newField.value_type = this.availableValueTypes[0]?.id;
                  this.handleValueTypeChange();
                },
                async handleValueTypeChange() {
                  this.availableTypesInForm = this.newField.getAvailableTypesInForm();
                  this.fixedValue = this.newField.value_type == 'fixed';
                  this.fixedValueOfOptions = this.fixedValue && this.newField.value_options.length > 0;
                  if(this.newField.type == 'date' || this.newField.type == 'datetime' || this.newField.type == 'datetimecombo') {
                    this.fixedType = 'date';
                  } else {
                    this.fixedType = 'text';
                  }
                  this.mustInForm = this.newField.mustInForm();

                  this.newField.type_in_form = this.availableTypesInForm[0]?.id;
                },
                async handleTypeInFormChange() {

                },
                async handleValueOptionsChange() {
                  this.newField.value_text = this.newField.value_options.find(o => o.id == this.newField.value)?.text ?? '';
                },
                async handleValueChange() {

                },
                async handleCreateField() {
                  item.fields.push(this.newField);
                  this.creatingField = false;
                },
                async provaActual(popup_reply_data) {
                            this.newField.value = popup_reply_data.name_to_value_array.assigned_user_id;
                            this.newField.value_text = popup_reply_data.name_to_value_array.assigned_user_name;
                          },
                }">
                <div class="row">
                  <button type="button" class="btn w-auto" x-show="!creatingField" @click="loadFields()">
                    [Añadir Campo]
                  </button>
                  <h4 x-show="creatingField">[Añadir Campo]</h4>
                </div>
                <div x-show="creatingField">
                  <div class="row align-items-end">
                    <!-- Field -->
                    <div class="col-3">
                      <label :for="`dataBlockFieldEdit${item.id}_Field_select`" class="form-label"
                        x-text="utils.translateForFieldLabel('LBL_FIELD')"></label>
                      <!-- Show all fields -->
                      <div class="text-muted form-check form-switch small">
                        <label :for="`dataBlockFieldEdit${item.id}_FieldAll_check`" class="form-label"
                                x-text="utils.translateForFieldLabel('LBL_FIELDS_SHOW_ALL')"></label>
                        <input class="form-check-input form-switch" type="checkbox" role="switch"
                                :id="`dataBlockFieldEdit${item.id}_FieldAll_check`" x-model="showAllFields" @change="reloadFields()"/>
                      </div>
                      <select :id="`dataBlockFieldEdit${item.id}_Field_select`" class="form-select" x-model="newField.name" @change="handleFieldChange()">
                        <template x-for="field in availableFields" :key="field.name">
                          <option :value="field.name" x-text="field.text"></option>
                        </template>
                      </select>
                    </div>
                    <!-- Value type -->
                    <div class="col-3">
                      <label :for="`dataBlockFieldEdit${item.id}_ValueType_select`" class="form-label"
                            x-text="utils.translateForFieldLabel('LBL_FIELD_VALUE_TYPE')"></label>
                      <select :id="`dataBlockFieldEdit${item.id}_ValueType_select`" class="form-select" x-model="newField.value_type" @change="handleValueTypeChange()">
                        <template x-for="type in availableValueTypes" :key="type.id">
                          <option :value="type.id" x-text="type.text"></option>
                        </template>
                      </select>
                    </div>
                    <!-- Type in form -->
                    <div class="col-3" x-show="availableTypesInForm.length > 1">
                      <label :for="`dataBlockFieldEdit${item.id}_TypeF_select`" class="form-label"
                            x-text="utils.translateForFieldLabel('LBL_FIELD_TYPE_IN_FORM')"></label>
                      <select :id="`dataBlockFieldEdit${item.id}_TypeF_select`" class="form-select" x-model="newField.type_in_form" @change="handleTypeInFormChange()">
                        <template x-for="type in availableTypesInForm" :key="type.id">
                          <option :value="type.id" x-text="type.text"></option>
                        </template>
                      </select>
                    </div>
                    <!-- Value (fixed value of enum) -->
                    <div class="col-3" x-show="fixedValueOfOptions">
                      <label :for="`dataBlockFieldEdit${item.id}_ValueFixedOfOptions`" class="form-label"
                            x-text="utils.translateForFieldLabel('LBL_FIELD_VALUE')"></label>
                      <select :id="`dataBlockFieldEdit${item.id}_ValueFixedOfOptions`" class="form-select" x-model="newField.value" @change="handleValueChange()">
                        <template x-for="option in newField.value_options" :key="option.id">
                          <option :value="option.id" x-text="option.text"></option>
                        </template>
                      </select>
                    </div>
                    <!-- Value (fixed value of related) -->
                    <div class="col-3 input-group">
                      <label :for="`dataBlockFieldEdit${item.id}_ValueFixedOfRelated`" class="form-label"
                             x-text="utils.translateForFieldLabel('LBL_FIELD_VALUE')"></label>
                      <input class="form-control" type="text" :id="`dataBlockFieldEdit${item.id}_ValueFixedOfRelated`" x-model="newField.value_text" 
                             autocomplete="off" @change="handleValueChange()" readonly/>
                      <input type="hidden" :id="`dataBlockFieldEdit${item.id}_ValueFixedOfRelatedId`" x-model="newField.value" />
                      <!-- IEPA!! Problema: Com cridar una funció de retorn?? -->
                      <button class="btn" type="button" 
                        @click="open_popup('Users', 600, 400, '', true, false, {
                          'call_back_function': 'provaActual', 
                          'field_to_name_array': {'id':'assigned_user_id', 'user_name':'assigned_user_name'}
                        },'single', true);">
                        <span class="suitepicon suitepicon-action-select"></span>
                      </button>
                      <button class="btn" type="button" @click="newField.value='';newField.value_text='';">
                        <span class="suitepicon suitepicon-action-clear"></span>
                      </button>
                    </div>
                    <!-- Value (fixed value) -->
                    <div class="col-3" x-show="fixedValue && !fixedValueOfOptions">
                      <label :for="`dataBlockFieldEdit${item.id}_ValueFixedOfDate`" class="form-label"
                            x-text="utils.translateForFieldLabel('LBL_FIELD_VALUE')"></label>
                      <input :id="`dataBlockFieldEdit${item.id}_ValueFixedOfDate`" :type="fixedType" class="form-control" x-model="newField.value" autocomplete="off" @change="handleValueChange()"/>
                    </div>                    
                    <!-- Value options -->
                    <!-- <div class="col-3" x-show="newField.type_in_form == 'dropdown' && !fixedValueOfOptions">
                      <label :for="`dataBlockFieldEdit${item.id}_ValueOptions_select`" class="form-label"
                            x-text="utils.translateForFieldLabel('LBL_FIELD_VALUE_OPTIONS')"></label>
                      <select :id="`dataBlockFieldEdit${item.id}_ValueOptions_select`" class="form-select" x-model="newField.value" @change="handleValueOptionsChange()">
                        <template x-for="option in newField.value_options" :key="option.id">
                          <option :value="option.id" x-text="option.text"></option>
                        </template>
                      </select>
                    </div> -->
                    <!-- Value Text-->
                    <!-- <div class="col-3" x-show="mustInForm && !fixedValueOfOptions">
                      <label :for="`dataBlockFieldEdit${item.id}_ValueText_text`" class="form-label"
                            x-text="utils.translateForFieldLabel('LBL_FIELD_VALUE_TEXT')"></label>
                      <input :id="`dataBlockFieldEdit${item.id}_ValueText_text`" type="text" class="form-control" x-model="newField.value_text" >
                    </div> -->
                    <!-- Label -->
                    <div class="col-3" x-show="mustInForm">
                      <label :for="`dataBlockFieldEdit${item.id}_Label_input`" class="form-label"
                            x-text="utils.translateForFieldLabel('LBL_FIELD_LABEL')"></label>
                      <input :id="`dataBlockFieldEdit${item.id}_Label_input`" type="text" class="form-control" x-model="newField.label" >
                    </div>
                    <!-- Required in form -->
                    <div class="col-2 form-switch" x-show="mustInForm">
                      <label :for="`dataBlockFieldEdit${item.id}_ReqF_check`" class="form-label"
                            x-text="utils.translateForFieldLabel('LBL_FIELD_REQUIRED_IN_FORM')"></label>
                      <input class="form-check-input form-switch" type="checkbox" role="switch"
                            :id="`dataBlockFieldEdit${item.id}_ReqF_check`" x-model="newField.required_in_form"/>
                    </div>
                    <button type="button" class="btn w-32px mb-1px" @click="handleCreateField();">
                      <span class="suitepicon suitepicon-action-confirm"></span>
                    </button>
                    <button type="button" class="btn w-32px mb-1px" @click="creatingField = false;">
                      <span class="suitepicon suitepicon-action-clear"></span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <!-- Duplicate Definition -->
            <template x-if="item.module">
              <div :id="`dataBlockDuplicates${item.id}`">
                <div class="row">
                  <!-- Action -->
                  <div class="col-3" :id="`duplicateAction${item.id}`" :data-model="'item.duplicate_detection.on_duplicate'" data-label="LBL_ONDUPLICATE_ACTION"
                        :data-map="utils.getList('stic_advanced_web_forms_datablocks_duplicate_action_list', true)" x-init="sticControls.fieldSelect($el)"></div>
                  <!-- Fields -->
                  <div class="col-9" :id="`duplicateFields${item.id}`" :data-model="'item.duplicate_detection.fields'" data-label="LBL_DUPLICATE_FIELDS"
                        :data-map="`utils.getModuleInformation('${item.module}').fields`" data-map-property="text" data-multiple
                        x-init="sticControls.fieldSelect($el)"></div>
                </div>
              </div>
            </template>
            <!-- Relationships Definition -->
            <template x-if="item.module">
              <div :id="`dataBlockRels${item.id}`">
                [Las relaciones del Bloque de datos]
                  <!-- Relationships Details -->
                <div x-data="{ showRelationshipsTable: false}">
                  <div class="text-muted form-check form-switch mt-3" :id="`dataRelationshipsDetails${item.id}`"
                        data-model="showRelationshipsTable" data-label-text="[Mostrar Detalles]" x-init="sticControls.fieldCheckbox($el);"></div>
                  <div class="card p-2 overflow-auto" x-show="showRelationshipsTable">
                    <div class="mt-3" :id="`dataBlockRelsTable${item.id}`"
                          :data-objects="`step2.usedDatablockRelationships('${item.id}')`" x-init="sticControls.elemTableObjects($el);"></div>
                  </div>
                </div>
                <!-- Add Relationship -->
                <div class="border-bottom ps-3 pt-3 mb-2 bg-light" x-data="{
                  creatingRelDataBlock: false,
                  availableRels: [],
                  selectedRelName:'',
                  availableDataBlocks: [],
                  selectedDataBlockId:'',
                  newDataBlockText:'',
                  relNewDataBlock:false,

                  async loadRelations() {
                    this.availableRels = step2.unusedDatablockRelationships(item.id);
                    this.selectedRelName = this.availableRels.length > 0 ? this.availableRels[0].name : '';
                    this.availableDataBlocks = [];
                    this.selectedDataBlockId = '';
                    this.creatingRelDataBlock = !this.creatingRelDataBlock;
                    this.handleRelationChange();
                  },
                  async handleRelationChange() {
                    this.availableDataBlocks = formConfig.getAvailableDataBlocksForRelationship(item.id, this.selectedRelName);
                    this.selectedDataBlockId = this.availableDataBlocks[0]?.id ?? -1;
                    this.handleDataBlockChange();
                  },
                  async handleDataBlockChange() {
                    this.newDataBlockText = '';
                    this.relNewDataBlock = this.selectedDataBlockId == -1;
                    if (this.relNewDataBlock) {
                      this.newDataBlockText = formConfig.suggestDataBlockText(formConfig.getRelationshipModule(item.id, this.selectedRelName));
                    }
                  },
                  async handleCreateRelationship(){
                    formConfig.addDataBlockRelationship(item.id, this.selectedRelName, this.selectedDataBlockId, this.newDataBlockText);
                    step2.loadDatablockRelationships();
                    this.creatingRelDataBlock = false;
                  },
                  }">
                  <div class="row">
                    <button type="button" class="btn w-auto" x-show="!creatingRelDataBlock" @click="loadRelations()">
                      [Añadir Relación con otro Bloque de Datos]
                    </button>
                    <h4 x-show="creatingRelDataBlock">[Añadir Relación con otro Bloque de Datos]</h4>
                  </div>
                  <div class="row align-items-end" x-show="creatingRelDataBlock">
                    <!-- Relationship -->
                    <div class="col-3">
                      <label :for="`dataBlockRelsEdit${item.id}_Rel_select`" class="form-label"
                            x-text="utils.translateForFieldLabel('LBL_RELATIONSHIP')"></label>
                      <select :id="`dataBlockRelsEdit${item.id}_Rel_select`" class="form-select" x-model="selectedRelName" @change="handleRelationChange()">
                        <template x-for="relation in availableRels" :key="relation.name">
                          <option :value="relation.name" x-text="relation.textExtended"></option>
                        </template>
                      </select>
                    </div>
                    <!-- Data Block -->
                    <div class="col-3">
                      <label :for="`dataBlockRelsEdit${item.id}_DataBlock_select`" class="form-label"
                            x-text="utils.translateForFieldLabel('LBL_DATABLOCK')"></label>
                      <select :id="`dataBlockRelsEdit${item.id}_DataBlock_select`" class="form-select" x-model="selectedDataBlockId" @change="handleDataBlockChange()">
                        <template x-for="dataBlock in availableDataBlocks" :key="dataBlock.id">
                          <option :value="dataBlock.id" x-text="dataBlock.text"></option>
                        </template>
                      </select>
                    </div>
                    <!-- New Data Block -->
                    <div class="col-3" x-show="relNewDataBlock">
                      <label :for="`dataBlockRelsEdit${item.id}_NewDataBlock_input`" class="form-label"
                              x-text="utils.translateForFieldLabel('LBL_NEW_DATABLOCK_NAME')"></label>
                      <input :id="`dataBlockRelsEdit${item.id}_NewDataBlock_input`" type="text" class="form-control" x-model="newDataBlockText" >
                    </div>
                    <button type="button" class="btn w-32px mb-1px" @click="handleCreateRelationship();">
                      <span class="suitepicon suitepicon-action-confirm"></span>
                    </button>
                    <button type="button" class="btn w-32px mb-1px" @click="creatingRelDataBlock = false;">
                      <span class="suitepicon suitepicon-action-clear"></span>
                    </button>
                  </div>
                </div>
              </div>
            </template>

            <!-- Accordion Headers -->
            <template x-if="item.module">
              <div :id="`dataDef_${item.id}`"
                    :data-sections="JSON.stringify([
                                    {headerText:`utils.translate('LBL_FIELDS') + ' ('+item.fields.length+')'`, selected:true, contentId:'dataBlockFields'+item.id},
                                    {headerText:`utils.translate('LBL_DUPLICATE_CHECK') + ' ('+item.duplicate_detection.fields.length+' - '+item.duplicate_detection.on_duplicate+')'`, selected:false, contentId:'dataBlockDuplicates'+item.id},
                                    {headerText:`utils.translate('LBL_RELATIONSHIPS')`, selected:false, contentId:'dataBlockRels'+item.id},
                                  ]);"
                    x-init="sticControls.accordion($el)"></div>
            </template>
            <template x-if="!item.module">
              <div :id="`dataDef_${item.id}`"
                    :data-sections="JSON.stringify([
                                    {headerText:`utils.translate('LBL_FIELDS') + ' (' + item.fields.length +')'`, selected:true, contentId:'dataBlockFields'+item.id},
                                  ]);"
                    x-init="sticControls.accordion($el)"></div>
            </template>
          </div>
        </div>
      </template>
    </div>
  </div>
  <!-- Details Data [DEBUG] -->
  <div x-data="{ showDetails: false}">
    <div class="text-muted form-check form-switch mb-3 mt-5" id="showDetailsDataToggleSwitch" data-model="showDetails" data-label-text="[Mostrar Detalles]"
         x-init="sticControls.fieldCheckbox($el);"></div>
    <div class="card p-2" x-show="showDetails">
      <!-- Data Blocks -->
      <div id="detailsDataBlocks">
        <div class="mt-3" id="dataBlocksTable" data-objects="formConfig.data_blocks" x-init="sticControls.elemTableObjects($el);"></div>
      </div>
      <!-- Relationships -->
      <div id="detailsRelationships">
        <div class="mt-3" id="relationshipsTable" data-objects="step2.allDatablockRelationships" data-model="step2.allDatablockRelationships"
        x-init="sticControls.elemListObject($el);"></div>
      </div>
      <!-- Tab Headers -->
      <div id="details"
           :data-sections="JSON.stringify([
                            {headerText:`'[Bloques de datos]'`, selected:true, contentId:'detailsDataBlocks'},
                            {headerText:`'[Relaciones]'`, selected:false, contentId:'detailsRelationships'},
                          ]);"
           x-init="sticControls.tabs($el)"></div>
    </div>
  </div>
</main>
