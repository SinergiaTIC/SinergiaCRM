<!-- Main Panel -->
<main class="wizard-main flex-fill d-flex flex-column" x-data="WizardStep4.mainStep4xData();">
    <div class="row h-100 g-0">
        <!-- Themes and configurations -->
         <div class="col-md-3 border-end bg-light overflow-auto p-3" style="max-height: calc(100vh - 200px);">
            <h4 class="h6 text-muted mb-2" x-text="utils.translate('LBL_THEME_COLORS')"></h4>
            <div class="row g-2 mb-3">
                <div class="col-4">
                    <label class="form-label small">Principal</label>
                    <input type="color" 
                           class="form-control form-control-color w-100" 
                           x-model="formConfig.layout.theme.primary_color"
                           :value="formConfig.layout.theme.primary_color" 
                           :style="`background-color: ${formConfig.layout.theme.primary_color}`">
                </div>
                <div class="col-4">
                    <label class="form-label small">Fons P√†gina</label>
                    <input type="color" 
                           class="form-control form-control-color w-100" 
                           x-model="formConfig.layout.theme.page_bg_color"
                           :value="formConfig.layout.theme.page_bg_color" 
                           :style="`background-color: ${formConfig.layout.theme.page_bg_color}`">
                </div>
                <div class="col-4">
                    <label class="form-label small">Fons Form.</label>
                    <input type="color" 
                           class="form-control form-control-color w-100" 
                           x-model="formConfig.layout.theme.form_bg_color"
                           :value="formConfig.layout.theme.form_bg_color" 
                           :style="`background-color: ${formConfig.layout.theme.form_bg_color}`">
                </div>
            </div>

            <hr class="text-muted opacity-25">

            <h4 class="h6 text-muted mb-2" x-text="utils.translate('LBL_THEME_STRUCTURE')"></h4>
            <div class="mb-2">
                <label class="form-label small d-flex justify-content-between mb-1">
                    <span>Columnes (Seccions)</span>
                    <span class="badge bg-light text-dark border" x-text="formConfig.layout.theme.sections_per_row"></span>
                </label>
                <input type="range" class="form-range" min="1" max="3" step="1" 
                       x-model.number="formConfig.layout.theme.sections_per_row">
                <div class="d-flex justify-content-between px-1 text-muted" style="font-size: 0.65rem; margin-top: -5px;">
                    <span>1</span><span>2</span><span>3</span>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label small d-flex justify-content-between mb-1">
                    <span>Columnes (Camps)</span>
                    <span class="badge bg-light text-dark border" x-text="formConfig.layout.theme.fields_per_row"></span>
                </label>
                <input type="range" class="form-range" min="1" max="4" step="1" 
                       x-model.number="formConfig.layout.theme.fields_per_row">
                <div class="d-flex justify-content-between px-1 text-muted" style="font-size: 0.65rem; margin-top: -5px;">
                    <span>1</span><span>2</span><span>3</span><span>4</span>
                </div>
            </div>

            <hr class="text-muted opacity-25">

            <h4 class="h6 text-muted mb-2" x-text="utils.translate('LBL_THEME_STYLE')"></h4>
            <div class="mb-3">
                <label class="form-label small d-flex justify-content-between mb-1">
                    <span>Arrodoniment</span>
                    <span class="text-muted small" x-text="formConfig.layout.theme.border_radius + 'px'"></span>
                </label>
                <input type="range" class="form-range" min="0" max="30" step="1" 
                       x-model.number="formConfig.layout.theme.border_radius">
            </div>

            <hr class="text-muted opacity-25">

            <h4 class="h6 text-muted mb-2" x-text="utils.translate('LBL_THEME_STYLE')"></h4>
            <div class="mb-3">
                <label class="form-label small d-flex justify-content-between mb-1">
                    Text del bot√≥ d'enviar                    
                </label>
                <input type="text" x-model="formConfig.layout.submit_button_text">
            </div>

            <details class="mb-3">
                <summary class="small text-primary cursor-pointer user-select-none">Opcions Avan√ßades</summary>
                
                <div class="card card-body bg-light mt-2 p-2 border-0">
                    <div class="mb-3">
                        <label class="form-label small">Tipografia</label>
                        <textarea rows="3" x-model="formConfig.layout.theme.font_family"></textarea>
                    </div>

                    <div class="mb-2 row align-items-center">
                        <label class="col-8 col-form-label small">Color del Text</label>
                        <div class="col-4">
                            <input type="color" 
                                class="form-control form-control-color w-100" 
                                x-model="formConfig.layout.theme.text_color"
                                :value="formConfig.layout.theme.text_color" 
                                :style="`background-color: ${formConfig.layout.theme.text_color}`">
                        </div>
                    </div>

                    <div class="mb-2 row align-items-center">
                        <label class="col-8 col-form-label small">Color del Borde</label>
                        <div class="col-4">
                            <input type="color" 
                                class="form-control form-control-color w-100" 
                                x-model="formConfig.layout.theme.border_color"
                                :value="formConfig.layout.theme.border_color" 
                                :style="`background-color: ${formConfig.layout.theme.border_color}`">
                        </div>
                    </div>

                    <div class="mb-0">
                        <label class="form-label small d-flex justify-content-between">
                            <span>Gruix Borde</span>
                            <span class="text-muted" x-text="formConfig.layout.theme.border_width + 'px'"></span>
                        </label>
                        <input type="range" class="form-range" min="0" max="5" step="1" 
                               x-model.number="formConfig.layout.theme.border_width">
                    </div>

                    <div class="mb-3">
                        <label class="form-label small">Amplada M√†xima</label>
                        <div class="input-group input-group-sm">
                            <select class="form-select" x-model="formConfig.layout.theme.form_width">
                                <option value="100%">Total (100%)</option>
                                <option value="1200px">Molt Ample (1200px)</option>
                                <option value="800px">Est√†ndard (800px)</option>
                                <option value="600px">Estret / M√≤bil (600px)</option>
                                <option value="custom">Personalitzat...</option>
                            </select>
                            <input type="text" class="form-control" x-show="formConfig.layout.theme.form_width == 'custom'" placeholder="Ex: 50rem">
                        </div>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label small">Mida Lletra</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control" min="12" max="24" step="1" 
                                    x-model="formConfig.layout.theme.font_size">
                                <span class="input-group-text">px</span>
                            </div>
                        </div>

                        <div class="col-6">
                            <label class="form-label small">Ombra (Shadow)</label>
                            <select class="form-select form-select-sm" x-model="formConfig.layout.theme.shadow_intensity">
                                <option value="none">Sense (Plana)</option>
                                <option value="sm">Subtil</option>
                                <option value="normal">Normal</option>
                                <option value="lg">Elevada (Flotant)</option>
                            </select>
                        </div>
                    </div>
                    <details class="mb-3">
                        <summary class="fw-bold cursor-pointer">üíª Codi Personalitzat (Avan√ßat)</summary>
                        
                        <div class="card card-body bg-light mt-2 border-0">
                            <div class="mb-3">
                                <label class="form-label small font-monospace">CSS Personalitzat</label>
                                <textarea class="form-control font-monospace small" rows="4" 
                                        x-model="formConfig.layout.custom_css" 
                                        placeholder=".btn { background: red !important; }"></textarea>
                                <div class="form-text text-muted extra-small">S'injectar√† dins d'un bloc &lt;style&gt;.</div>
                            </div>

                            <div class="mb-0">
                                <label class="form-label small font-monospace">JavaScript Personalitzat</label>
                                <textarea class="form-control font-monospace small" rows="4" 
                                        x-model="formConfig.layout.custom_js" 
                                        placeholder="console.log('Form loaded');"></textarea>
                                <div class="form-text text-muted extra-small">S'injectar√† al final del formulari.</div>
                            </div>
                        </div>
                    </details>                    
                </div>
            </details>
        </div>

        <!-- Form design -->
        <div class="col-md-9 p-4 bg-white overflow-auto" style="max-height: calc(100vh - 200px);">
            <h2 x-text="utils.translate('LBL_LAYOUT_FORM_DESIGN')"></h2>
            <div class="accordion">
                <!-- Header -->
                <div class="accordion-item" x-data="{opened:false}">
                    <div id="LayoutHeader_Header" class="accordion-header accordion-button" role="button" 
                         :class="{'collapsed': !opened}" @click="opened = !opened" data-bs-toggle="collapse" 
                         data-bs-target="#LayoutHeader_Content" aria-controls="LayoutHeader_Content">
                        <h3 x-text="utils.translate('LBL_LAYOUT_HEADER')"></h3>
                    </div>
                    <div id="LayoutHeader_Content" class="accordion-collapse collapse" aria-labelledby="LayoutHeader_Header">
                        <div id="LayoutHeader_Body" class="accordion-body"> 
                            <div class="bg-white text-dark"> 
                                <div x-data="quillEditor(formConfig.layout.header_html, (html) => formConfig.layout.header_html = html)">
                                    <div class="bg-white border rounded overflow-hidden">
                                        <div x-ref="editor" style="height: 175px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Body -->
                <div class="accordion-item">
                    <div id="LayoutBody_Header" class="pt-3 ps-3 accordion-header card-header" aria-controls="LayoutBody_Content">
                        <h3 x-text="utils.translate('LBL_LAYOUT_BODY')"></h3>
                    </div>
                    <div id="LayoutBody_Content" class="accordion-collapse show" aria-labelledby="LayoutBody_Header">
                        <div id="LayoutBody_Body" class="accordion-body"> 
                            <div class="flex-fill border rounded p-2 overflow-auto">
                                <h4 class="mb-2" x-text="utils.translate('LBL_SECTIONS')"></h3>
                                <template x-for="(section, index) in formConfig.layout.structure" :key="section.id">
                                    <div class="card datablock">
                                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                            <span :id="`sectionTitleEdit-${section.id}`" data-model="section.title" x-init="sticControls.editableText($el);"></span>
                                            <!-- Buttons -->
                                            <div class="d-inline-flex">
                                                <div class="d-inline-flex input-group" role="group">
                                                    <button type="button" class="btn" :title="utils.translate('LBL_BUTTON_MOVE_UP')"
                                                            :disabled="!canMoveUpSection(section);" @click="moveUpSection(section);">
                                                        <span class="suitepicon suitepicon-action-move-up"></span>
                                                    </button>
                                                    <button type="button" class="btn" :title="utils.translate('LBL_BUTTON_MOVE_DOWN')"
                                                            :disabled="!canMoveDownSection(section);" @click="moveDownSection(section);">
                                                        <span class="suitepicon suitepicon-action-move-down"></span>
                                                    </button>
                                                </div> 
                                                <button type="button" class="btn ms-2" :title="utils.translate('LBL_BUTTON_DELETE')"
                                                        :disabled="!canDeleteSection(section);" @click="deleteSection(section);">
                                                    <span class="suitepicon suitepicon-action-delete"></span>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body bg-white">
                                            <div class="accordion">
                                                <!-- Configuration -->
                                                <div class="accordion-item" x-data="{opened:false}">
                                                    <div :id="`sectionConfig${section.id}_Header`" class="accordion-header accordion-button" role="button" 
                                                        :class="{'collapsed': !opened}" @click="opened = !opened" data-bs-toggle="collapse" 
                                                        :data-bs-target="#`sectionConfig${section.id}_Content`" :aria-controls="`sectionConfig${section.id}_Content`"
                                                        x-text="utils.translate('LBL_SECTION_CONFIG')">
                                                    </div>
                                                    <div :id="`sectionConfig${section.id}_Content`" class="accordion-collapse collapse" 
                                                         :aria-labelledby="`sectionConfig${section.id}_Header`">
                                                        <div :id="`sectionConfig${section.id}_Body`" class="accordion-body"> 
                                                            <!-- TODO: Add Configuration-->
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Content -->
                                                <div class="accordion-item" x-data="{opened:false}">
                                                    <div :id="`sectionContent${section.id}_Header`" class="accordion-header accordion-button" role="button" 
                                                        :class="{'collapsed': !opened}" @click="opened = !opened" data-bs-toggle="collapse" 
                                                        :data-bs-target="#`sectionContent${section.id}_Content`" :aria-controls="`sectionContent${section.id}_Content`"
                                                        x-text="utils.translate('LBL_SECTION_CONTENT')">
                                                    </div>
                                                    <div :id="`sectionContent${section.id}_Content`" class="accordion-collapse collapse" 
                                                         :aria-labelledby="`sectionContent${section.id}_Header`">
                                                        <div :id="`sectionContent${section.id}_Body`" class="accordion-body"> 
                                                            <!-- TODO: Add Content -->
                                                            <template x-for="element in section.elements" :key="element.id">
                                                                <div class="form-check form-check-inline border rounded px-2 py-1 m-0" >
                                                                    <span class="form-check-label small" x-text="element.ref_id"></span>
                                                                </div>
                                                            </template>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                                <button type="button" class="btn w-auto" x-text="utils.translate('LBL_SECTION_ADD')" @click="createSection"></button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="accordion-item" x-data="{opened:false}">
                    <div id="LayoutFooter_Header" class="accordion-header accordion-button" role="button" 
                         :class="{'collapsed': !opened}" @click="opened = !opened" data-bs-toggle="collapse" 
                         data-bs-target="#LayoutFooter_Content" aria-controls="LayoutFooter_Content">
                        <h3 x-text="utils.translate('LBL_LAYOUT_FOOTER')"></h3>
                    </div>
                    <div id="LayoutFooter_Content" class="accordion-collapse collapse" aria-labelledby="LayoutFooter_Header">
                        <div id="LayoutFooter_Body" class="accordion-body"> 
                            <div class="bg-white text-dark"> 
                                <div x-data="quillEditor(formConfig.layout.footer_html, (html) => formConfig.layout.footer_html = html)">
                                    <div class="bg-white border rounded overflow-hidden">
                                        <div x-ref="editor" style="height: 175px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>