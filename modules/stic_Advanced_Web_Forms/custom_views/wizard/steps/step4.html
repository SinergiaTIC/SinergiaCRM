<!-- Main Panel -->
<main class="wizard-main flex-fill d-flex flex-column" x-data="WizardStep4.mainStep4xData();">
    <div class="row h-100 g-0">
        <!-- Themes and configurations -->
         <div class="col-md-3 border-end bg-light overflow-auto p-3" style="max-height: calc(100vh - 200px);">
            <h3 class="mb-3" x-text="utils.translate('LBL_LAYOUT_SETTINGS')"></h3>

            <!-- submit_button_text -->
            <div class="mb-3 row">
                <label for="theme-submit_button_text" class="form-label small" x-text="utils.translateForFieldLabel('LBL_THEME_SUBMIT_BUTTON_TEXT')"></label>
                <input id="theme-submit_button_text" type="text" x-model="formConfig.layout.submit_button_text">
            </div>

            <!-- Main colors -->
            <details class="mb-3">
                <summary class="cursor-pointer user-select-none" x-text="utils.translate('LBL_THEME_MAIN_COLORS')"></summary>
                <div class="ps-4 g-2  mt-2">
                    <!-- primary_color -->
                    <div class="mb-3">
                        <label for="theme-primary_color" class="form-label small" x-text="utils.translateForFieldLabel('LBL_THEME_PRIMARY_COLOR')"></label>
                        <input id="theme-primary_color" type="color" class="form-control form-control-color w-100" x-model="formConfig.layout.theme.primary_color"
                               :value="formConfig.layout.theme.primary_color" :style="`background-color: ${formConfig.layout.theme.primary_color}`">
                    </div>
                    <!-- page_bg_color -->
                    <div class="mb-3">
                        <label for="theme-page_bg_color" class="form-label small" x-text="utils.translateForFieldLabel('LBL_THEME_PAGE_BG_COLOR')"></label>
                        <input id="theme-page_bg_color" type="color" class="form-control form-control-color w-100" x-model="formConfig.layout.theme.page_bg_color"
                               :value="formConfig.layout.theme.page_bg_color" :style="`background-color: ${formConfig.layout.theme.page_bg_color}`">
                    </div>
                    <!-- form_bg_color -->
                    <div class="mb-3">
                        <label for="theme-form_bg_color" class="form-label small" x-text="utils.translateForFieldLabel('LBL_THEME_FORM_BG_COLOR')"></label>
                        <input id="theme-form_bg_color" type="color" class="form-control form-control-color w-100" x-model="formConfig.layout.theme.form_bg_color"
                               :value="formConfig.layout.theme.form_bg_color" :style="`background-color: ${formConfig.layout.theme.form_bg_color}`">
                    </div>
                </div>
            </details>

            <!-- Typography and text-->
            <details class="mb-3">
                <summary class="cursor-pointer user-select-none" x-text="utils.translate('LBL_THEME_TYPOGRAPGY_TEXT')"></summary>
                <div class="ps-4 g-2 mt-2">
                    <!-- font_family -->
                    <div class="mb-3">
                        <label for="theme-font_family" class="form-label small" x-text="utils.translateForFieldLabel('LBL_THEME_FONT_FAMILY')"></label>
                        <textarea id="theme-font_family" rows="3" x-model="formConfig.layout.theme.font_family"></textarea>
                    </div>
                    <!-- font_size -->
                    <div class="mb-3">
                        <label for="theme-font_size" class="form-label small d-flex justify-content-between">
                            <span x-text="utils.translateForFieldLabel('LBL_THEME_FONT_SIZE')"></span>
                            <span class="text-muted" x-text="formConfig.layout.theme.font_size + 'px'"></span>
                        </label>
                        <input id="theme-font_size" type="range" class="form-range" min="8" max="26" step="1" 
                               x-model.number="formConfig.layout.theme.font_size">
                    </div>
                    <!-- text_color -->
                    <div class="mb-3">
                        <label for="theme-text_color" class="form-label small" x-text="utils.translateForFieldLabel('LBL_THEME_TEXT_COLOR')"></label>
                        <input id="theme-text_color" type="color" class="form-control form-control-color w-100" x-model="formConfig.layout.theme.text_color"
                               :value="formConfig.layout.theme.text_color" :style="`background-color: ${formConfig.layout.theme.text_color}`">
                    </div>
                </div>
            </details>

            <!-- Borders -->
            <details class="mb-3">
                <summary class="cursor-pointer user-select-none" x-text="utils.translate('LBL_THEME_BORDERS')"></summary>
                <div class="ps-4 g-2 mt-2">
                    <!-- border_radius -->
                    <div class="mb-3">
                        <label for="theme-border_radius" class="form-label small d-flex justify-content-between">
                            <span x-text="utils.translateForFieldLabel('LBL_THEME_BORDER_RADIUS')"></span>
                            <span class="text-muted" x-text="formConfig.layout.theme.border_radius + 'px'"></span>
                        </label>
                        <input id="theme-border_radius" type="range" class="form-range" min="0" max="30" step="1" 
                               x-model.number="formConfig.layout.theme.border_radius">
                    </div>
                    <!-- border_width -->
                    <div class="mb-3">
                        <label for="theme-border_width" class="form-label small d-flex justify-content-between">
                            <span x-text="utils.translateForFieldLabel('LBL_THEME_BORDER_WIDTH')"></span>
                            <span class="text-muted" x-text="formConfig.layout.theme.border_width + 'px'"></span>
                        </label>
                        <input id="theme-border_width" type="range" class="form-range" min="0" max="5" step="1" 
                               x-model.number="formConfig.layout.theme.border_width">
                    </div>
                    <!-- border_color -->
                    <div class="mb-3">
                        <label for="theme-border_color" class="form-label small" x-text="utils.translateForFieldLabel('LBL_THEME_BORDER_COLOR')"></label>
                        <input id="theme-border_color" type="color" class="form-control form-control-color w-100" x-model="formConfig.layout.theme.border_color"
                               :value="formConfig.layout.theme.border_color" :style="`background-color: ${formConfig.layout.theme.border_color}`">
                    </div>
                    <!-- shadow_intensity -->
                    <div class="mb-3">
                        <label for="theme-shadow_intensity" class="form-label small" x-text="utils.translateForFieldLabel('LBL_THEME_SHADOW_INTENSITY')"></label>
                        <select id="theme-shadow_intensity" class="form-select" x-model="formConfig.layout.theme.shadow_intensity">
                            <template x-for="item in AWF_Theme.shadow_intensity_in_formList()" :key="item.id">
                                <option :value="item.id" x-text="item.text" :selected="item.id == formConfig.layout.theme.shadow_intensity"></option>
                            </template>
                        </select>
                    </div>
                </div>
            </details>

            <!-- Structure -->
            <details class="mb-3">
                <summary class="cursor-pointer user-select-none" x-text="utils.translate('LBL_THEME_STRUCTURE')"></summary>
                <div class="ps-4 g-2 mt-2">
                    <!-- form_width -->
                    <div class="mb-3">
                        <label for="theme-form_width" class="form-label small" x-text="utils.translateForFieldLabel('LBL_THEME_FORM_WIDTH')"></label>
                        <select id="theme-form_width" class="form-select" x-model="formConfig.layout.theme.form_width">
                            <template x-for="item in AWF_Theme.form_width_in_formList()" :key="item.id">
                                <option :value="item.id" x-text="item.text" :selected="item.id == formConfig.layout.theme.form_width"></option>
                            </template>
                        </select>
                    </div>  
                    <!-- sections_per_row -->
                    <div class="mb-3">
                        <label for="theme-sections_per_row" class="form-label small d-flex justify-content-between mb-1">
                            <span x-text="utils.translateForFieldLabel('LBL_THEME_SECTIONS_PER_ROW')"></span>
                            <span class="badge bg-light text-dark border" x-text="formConfig.layout.theme.sections_per_row"></span>
                        </label>
                        <input id="theme-sections_per_row" type="range" class="form-range" min="1" max="3" step="1" 
                               x-model.number="formConfig.layout.theme.sections_per_row">
                        <div class="d-flex justify-content-between px-1 text-muted" style="font-size: 0.65rem; margin-top: -5px;">
                            <span>1</span><span>2</span><span>3</span>
                        </div>
                    </div>
                    <!-- fields_per_row -->
                    <div class="mb-3">
                        <label for="theme-fields_per_row" class="form-label small d-flex justify-content-between mb-1">
                            <span x-text="utils.translateForFieldLabel('LBL_THEME_FIELDS_PER_ROW')"></span>
                            <span class="badge bg-light text-dark border" x-text="formConfig.layout.theme.fields_per_row"></span>
                        </label>
                        <input id="theme-fields_per_row" type="range" class="form-range" min="1" max="4" step="1" 
                               x-model.number="formConfig.layout.theme.fields_per_row">
                        <div class="d-flex justify-content-between px-1 text-muted" style="font-size: 0.65rem; margin-top: -5px;">
                            <span>1</span><span>2</span><span>3</span><span>4</span>
                        </div>
                    </div>
                </div>
            </details>

            <!-- Advanced -->
            <details class="mb-3">
                <summary class="cursor-pointer user-select-none" x-text="utils.translate('LBL_THEME_ADVANCED')"></summary>
                <div class="ps-4 g-2 mt-2">
                    <!-- custom_css -->
                    <div class="mb-3">
                        <label for="theme-custom_css" class="form-label small" x-text="utils.translateForFieldLabel('LBL_THEME_CUSTOM_CSS')"></label>
                        <textarea id="theme-custom_css" class="form-control font-monospace small" rows="4" x-model="formConfig.layout.custom_css" 
                                  placeholder=".btn { background: red !important; }"></textarea>
                        <div class="form-text text-muted extra-small" x-text="utils.translate('LBL_THEME_CUSTOM_CSS_DESC')"></div>
                    </div>
                    <!-- custom_js -->
                    <div class="mb-3">
                       <label for="theme-custom_js" class="form-label small" x-text="utils.translateForFieldLabel('LBL_THEME_CUSTOM_JS')"></label>
                        <textarea id="theme-custom_js" class="form-control font-monospace small" rows="4" x-model="formConfig.layout.custom_js" 
                                  placeholder="console.log('Form loaded');"></textarea>
                        <div class="form-text text-muted extra-small" x-text="utils.translate('LBL_THEME_CUSTOM_JS_DESC')"></div>
                    </div>
                </div>
            </details>

            <!-- Reset Button -->
            <button type="button" class="btn w-auto" x-text="utils.translate('LBL_THEME_RESET_BUTTON')" @click="resetTheme()"></button>
        </div>

        <!-- Form design -->
        <div class="col-md-9 p-4 bg-white overflow-auto" style="max-height: calc(100vh - 200px);">
            <h2 x-text="utils.translate('LBL_LAYOUT_FORM_DESIGN')"></h2>
            <div class="accordion">
                <!-- Header -->
                <div class="accordion-item" x-data="{opened:false}">
                    <div id="LayoutHeader_Header" class="accordion-header accordion-button" role="button" 
                         :class="{'collapsed': !opened}" @click="opened = !opened" data-bs-toggle="collapse" 
                         data-bs-target="#LayoutHeader_Content" aria-controls="LayoutHeader_Content">
                        <h3 x-text="utils.translate('LBL_LAYOUT_HEADER')"></h3>
                    </div>
                    <div id="LayoutHeader_Content" class="accordion-collapse collapse" aria-labelledby="LayoutHeader_Header">
                        <div id="LayoutHeader_Body" class="accordion-body"> 
                            <div class="bg-white text-dark"> 
                                <div x-data="quillEditor(formConfig.layout.header_html, (html) => formConfig.layout.header_html = html)">
                                    <div class="bg-white border rounded overflow-hidden">
                                        <div x-ref="editor" style="height: 175px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Body -->
                <div class="accordion-item">
                    <div id="LayoutBody_Header" class="pt-3 ps-3 accordion-header card-header" aria-controls="LayoutBody_Content">
                        <h3 x-text="utils.translate('LBL_LAYOUT_BODY')"></h3>
                    </div>
                    <div id="LayoutBody_Content" class="accordion-collapse show" aria-labelledby="LayoutBody_Header">
                        <div id="LayoutBody_Body" class="accordion-body"> 
                            <div class="flex-fill border rounded p-2 overflow-auto">
                                <h4 class="mb-2" x-text="utils.translate('LBL_SECTIONS')"></h3>
                                <template x-for="(section, index) in formConfig.layout.structure" :key="section.id">
                                    <div class="card datablock">
                                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                            <span :id="`sectionTitleEdit-${section.id}`" data-model="section.title" x-init="sticControls.editableText($el);"></span>
                                            <!-- Buttons -->
                                            <div class="d-inline-flex">
                                                <div class="d-inline-flex input-group" role="group">
                                                    <button type="button" class="btn" :title="utils.translate('LBL_BUTTON_MOVE_UP')"
                                                            :disabled="!canMoveUpSection(section);" @click="moveUpSection(section);">
                                                        <span class="suitepicon suitepicon-action-move-up"></span>
                                                    </button>
                                                    <button type="button" class="btn" :title="utils.translate('LBL_BUTTON_MOVE_DOWN')"
                                                            :disabled="!canMoveDownSection(section);" @click="moveDownSection(section);">
                                                        <span class="suitepicon suitepicon-action-move-down"></span>
                                                    </button>
                                                </div> 
                                                <button type="button" class="btn ms-2" :title="utils.translate('LBL_BUTTON_DELETE')"
                                                        :disabled="!canDeleteSection(section);" @click="deleteSection(section);">
                                                    <span class="suitepicon suitepicon-action-delete"></span>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body bg-white">
                                            <div class="accordion">
                                                <!-- Configuration -->
                                                <div class="accordion-item" x-data="{opened:false}">
                                                    <div :id="`sectionConfig${section.id}_Header`" class="accordion-header accordion-button" role="button" 
                                                        :class="{'collapsed': !opened}" @click="opened = !opened" data-bs-toggle="collapse" 
                                                        :data-bs-target="`#sectionConfig${section.id}_Content`" :aria-controls="`sectionConfig${section.id}_Content`"
                                                        x-text="utils.translate('LBL_SECTION_CONFIG')">
                                                    </div>
                                                    <div :id="`sectionConfig${section.id}_Content`" class="accordion-collapse collapse" 
                                                         :aria-labelledby="`sectionConfig${section.id}_Header`">
                                                        <div :id="`sectionConfig${section.id}_Body`" class="accordion-body row"> 
                                                            <!-- Configuration -->
                                                            <!-- Title -->
                                                            <div class="col-3">
                                                                <label :for="`section${section.id}_title`" class="form-label" x-text="utils.translateForFieldLabel('LBL_SECTION_TITLE')"></label>
                                                                <input :id="`section${section.id}_title`" type="text" class="form-control" autocomplete="off" x-model="section.title"/>
                                                            </div>
                                                            <!-- Show Title -->
                                                            <div class="col-3 form-check form-switch">
                                                                <label :for="`section${section.id}_showTitle`" class="form-label" x-text="utils.translate('LBL_SECTION_SHOW_TITLE')"></label>
                                                                <input :id="`section${section.id}_showTitle`" class="form-check-input form-switch" type="checkbox" role="switch" x-model="section.showTitle"/>
                                                            </div>
                                                            <!-- Container Type -->
                                                            <div class="col-3">
                                                                <label :for="`section${section.id}_containerType`" class="form-label" x-text="utils.translateForFieldLabel('LBL_SECTION_CONTAINER')"></label>
                                                                <select :id="`section${section.id}_containerType`" class="form-select" x-model="section.containerType">
                                                                    <template x-for="type in availableContainerTypes" :key="type.id">
                                                                        <option :value="type.id" x-text="type.text" :selected="type.id == section.containerType"></option>
                                                                    </template>
                                                                </select>
                                                            </div>

                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Content -->
                                                <div class="accordion-item" x-data="{opened:false}">
                                                    <div :id="`sectionContent${section.id}_Header`" class="accordion-header accordion-button" role="button" 
                                                        :class="{'collapsed': !opened}" @click="opened = !opened" data-bs-toggle="collapse" 
                                                        :data-bs-target="`#sectionContent${section.id}_Content`" :aria-controls="`sectionContent${section.id}_Content`"
                                                        x-text="utils.translate('LBL_SECTION_CONTENT')">
                                                    </div>
                                                    <div :id="`sectionContent${section.id}_Content`" class="accordion-collapse collapse" 
                                                         :aria-labelledby="`sectionContent${section.id}_Header`">
                                                        <div :id="`sectionContent${section.id}_Body`" class="accordion-body"> 
                                                            <!-- Content -->
                                                            <template x-for="(element, index) in section.elements" :key="element.id">
                                                                <div class="card mb-2 border-secondary">
                                                                    <div class="card-header bg-light p-2 d-flex justify-content-between align-items-center">
                                                                        <strong x-text="getElementHeader(element)"></strong>
                                                                        <div class="d-inline-flex gap-2">
                                                                            <select class="form-select small text-muted" @change="moveElementToSection(element, section.id, $event.target.value)">
                                                                                <option value="" disabled selected x-text="utils.translate('LBL_SECTION_MOVE_ELEMENT_NO_OPTION')"></option>
                                                                                <template x-for="sec in formConfig.layout.structure" :key="sec.id">
                                                                                    <option :value="sec.id" x-text="sec.title || utils.translate('LBL_SECTION_NO_TITLE')" 
                                                                                            x-show="sec.id !== section.id"></option>
                                                                                </template>
                                                                            </select>

                                                                            <div class="input-group" role="group">
                                                                                <button type="button" class="btn" :title="utils.translate('LBL_BUTTON_MOVE_UP')"
                                                                                        :disabled="index === 0" @click="moveElementUp(section, index);">
                                                                                    <span class="suitepicon suitepicon-action-move-up"></span>
                                                                                </button>
                                                                                <button type="button" class="btn" :title="utils.translate('LBL_BUTTON_MOVE_DOWN')"
                                                                                        :disabled="index === section.elements.length - 1" @click="moveElementDown(section, index)">                                                                                
                                                                                    <span class="suitepicon suitepicon-action-move-down"></span>
                                                                                </button>
                                                                            </div> 
                                                                        </div>
                                                                    </div>

                                                                    <div class="card-body">
                                                                        <template x-if="element.type=='datablock'">
                                                                            <template x-for="field in getFields(element)" :key="field.name">
                                                                                <div class="form-check form-check-inline border rounded px-2 py-1 m-0" x-text="field.label"></div>
                                                                            </template>
                                                                        </template>
                                                                    </div>
                                                                </div>
                                                            </template>
                                                            <template x-if="section.elements.length === 0">
                                                                <div class="text-center text-muted small fst-italic py-2" x-text="utils.translate('LBL_SECTION_EMPTY_DESC')"></div>
                                                            </template>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                                <button type="button" class="btn w-auto" x-text="utils.translate('LBL_SECTION_ADD')" @click="createSection"></button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="accordion-item" x-data="{opened:false}">
                    <div id="LayoutFooter_Header" class="accordion-header accordion-button" role="button" 
                         :class="{'collapsed': !opened}" @click="opened = !opened" data-bs-toggle="collapse" 
                         data-bs-target="#LayoutFooter_Content" aria-controls="LayoutFooter_Content">
                        <h3 x-text="utils.translate('LBL_LAYOUT_FOOTER')"></h3>
                    </div>
                    <div id="LayoutFooter_Content" class="accordion-collapse collapse" aria-labelledby="LayoutFooter_Header">
                        <div id="LayoutFooter_Body" class="accordion-body"> 
                            <div class="bg-white text-dark"> 
                                <div x-data="quillEditor(formConfig.layout.footer_html, (html) => formConfig.layout.footer_html = html)">
                                    <div class="bg-white border rounded overflow-hidden">
                                        <div x-ref="editor" style="height: 175px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>