<!-- Main Panel -->
<main class="wizard-main flex-fill d-flex flex-column" x-data="WizardStep3.mainStep3xData();">
    <!-- Flows -->
    <div class="flex-fill border rounded p-2 overflow-auto">
        <h2 class="mb-2" x-text="utils.translate('LBL_FLOWS')"></h2>
        <!-- Show all Actions -->
        <div class="text-muted form-check form-switch small p-3" x-init="utils.setInlineHelpQtip()">
            <label for="actions_allcheck" class="form-label" x-text="utils.translate('LBL_ACTIONS_SHOW_ALL')"></label>
            <i class="inline-help glyphicon glyphicon-info-sign"></i>
            <div class="inline-help-content" style="display:none;" x-text="utils.translate('LBL_ACTIONS_SHOW_ALL_DESC')"></div>
            <input class="form-check-input form-switch" type="checkbox" role="switch" id="actions_allcheck" x-model="showAllActions"/>
        </div>
        <!-- Tab Headers: Flows -->
        <div class="stic-tabs">
            <template x-for="flow in formConfig.flows" :key="flow.id">
                <div class="stic-tab">
                    <input class="form-check-input" type="radio" :id="`flowTab${flow.id}`" x-model="flowTabSelected" :value="`${flow.id}`"/>
                    <label class="form-label" :for="`flowTab${flow.id}`" x-text="flow.getText()"></label>
                </div>
            </template>
        </div>
        <!-- Tab Content: Flows -->
        <div class="stic-tabcontent">
            <!-- Actions -->
            <div class="accordion">
                <template x-for="action in actions" :key="action.id">
                    <div class="accordion-item" x-data="{opened:false}" x-show="action.is_user_selectable || showAllActions">
                        <div :id="action.id+'_Header'" class="mt-1 mb-1 pe-2 btn accordion-header accordion-button p-0 align-items-center" :class="{'collapsed': !opened}">
                            <div class="d-flex flex-grow-1 align-items-center py-3 ps-3 pe-2" role="button" @click="opened = !opened"
                                 data-bs-toggle="collapse" :data-bs-target="'#'+action.id+'_Content'" :aria-controls="action.id+'_Content'">
                                <div class="fw-bold text-truncate" style="max-width: 30%;">
                                    <span :id="`actionTextEdit-${action.id}`" data-model="action.text" x-init="sticControls.editableText($el);"></span>
                                </div>
                                <div class="text-muted small text-truncate px-2" style="flex: 1; text-align: center;">
                                    <span x-text="action.description"></span>
                                </div>
                            </div>
                            <!-- Buttons -->
                            <template x-if="showAllActions">
                                <div class="d-flex align-items-center pe-3">
                                    <div class="d-inline-flex input-group" role="group">
                                        <button type="button" class="btn" :title="utils.translate('LBL_BUTTON_MOVE_UP')"
                                                :disabled="!canMoveUpAction(action);" @click="moveUpAction(action);">
                                            <span class="suitepicon suitepicon-action-move-up"></span>
                                        </button>
                                        <button type="button" class="btn" :title="utils.translate('LBL_BUTTON_MOVE_DOWN')"
                                                :disabled="!canMoveDownAction(action);" @click="moveDownAction(action);">
                                            <span class="suitepicon suitepicon-action-move-down"></span>
                                        </button>
                                    </div> 
                                </div>
                            </template>
                        </div>
                        <div :id="action.id+'_Content'" class="accordion-collapse collapse" :aria-labelledby="action.id+'_Header'">
                            <div :id="action.id+'_Body'" class="accordion-body"> 
                                <!-- Action details-->
                                <table class="table table-bordered align-middle" >
                                    <colgroup>
                                        <col style="width:30%">
                                        <col style="width:20%">
                                        <col style="width:40%">
                                        <template x-if="action.is_user_selectable">
                                            <col style="width:10%">
                                        </template>
                                    </colgroup>
                                    <thead class="table-light">
                                        <tr>
                                            <th x-text="utils.translate('LBL_ACTION_NAME')"></th>
                                            <th x-text="utils.translate('LBL_ACTION_CATEGORY')"></th>
                                            <th x-text="utils.translate('LBL_ACTION_PARAMETERS')"></th>
                                            <template x-if="action.is_user_selectable">
                                                <th x-text="utils.translate('LBL_ACTION_ACTIONS')"></th>
                                            </template>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <!-- Name -->
                                            <td><strong :id="`actionTextEdit-${action.id}`" data-model="action.text" x-init="sticControls.editableText($el);"></strong></td>
                                            <!-- Category -->
                                            <td x-text="action.category_in_formText"></td>
                                            <!-- Parameters -->
                                            <td rowspan="2" class="p-0">
                                                <table class="table table-sm mb-0">
                                                    <tbody>
                                                        <template x-for="param in action.parameters" :key="param.name">
                                                            <tr>
                                                                <th class="w-25" x-text="param.text"></th>
                                                                <td x-text="param.value_text"></td>
                                                            </tr>
                                                        </template>
                                                    </tbody>
                                                </table>
                                            </td>
                                            <!-- Buttons -->
                                            <template x-if="action.is_user_selectable">
                                                <td rowspan="2">
                                                    <button type="button" class="btn" :title="utils.translate('LBL_BUTTON_EDIT')"
                                                            :disabled="!canEditAction(action);" @click="$store.actionEditor.openEdit(action);">
                                                        <span class="suitepicon suitepicon-action-edit"></span>
                                                    </button>
                                                    <button type="button" class="btn ms-2" :title="utils.translate('LBL_BUTTON_DELETE')"
                                                            :disabled="!canRemoveAction(action);" @click="removeAction(action);">
                                                        <span class="suitepicon suitepicon-action-delete"></span>
                                                    </button>
                                                </td>
                                            </template>
                                        </tr>
                                        <tr>
                                            <td colspan="2" class="text-muted small" x-text="action.description"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>                        
                    </div>
                </template>
            </div>
            <!-- Create Action Button -->
            <div class="row m-3">
                <button type="button" class="btn w-auto" x-text="utils.translate('LBL_ACTION_ADD')" 
                        @click="$store.actionEditor.openCreate(flow, false)"></button>
                <button type="button" class="btn w-auto" x-text="utils.translate('LBL_ACTION_TERMINAL_ADD')" 
                        @click="$store.actionEditor.openCreate(flow, true)"
                        x-bind:disabled="flow.hasTerminalAction();"></button>
                <!-- <button type="button" class="btn w-auto" @click="$store.fieldEditor.openCreate(item, 'form')" x-text="utils.translate('LBL_ACTION_ADD')"></button> -->
            </div>
        </div>
    </div>

    <!-- Modal: Create Action -->
    <div x-show="$store.actionEditor.isOpen" x-cloak class="custom-modal-wrapper">
        <div class="custom-modal-backdrop"></div>
        <div class="custom-modal-dialog modal-lg" role="dialog">
            <div class="custom-modal-content">
                
                <div class="custom-modal-header">
                    <h3 class="modal-title" x-text="$store.actionEditor.title"></h3>
                    <button type="button" class="btn-close" @click="$store.actionEditor.close()"></button>
                </div>

                <div class="custom-modal-body bg-light">
                    
                    <div class="card mb-3">
                        <div class="card-header" x-text="utils.translate('LBL_ACTION')"></div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-3">
                                    <label class="form-label" x-text="utils.translateForFieldLabel('LBL_CATEGORY')"></label>
                                    <select class="form-select" x-model="$store.actionEditor.selectedCategory" :disabled="$store.actionEditor.isEdit">
                                        <template x-for="cat in $store.actionEditor.availableCategories" :key="cat.id">
                                            <option :value="cat.id" x-text="cat.text"></option>
                                        </template>
                                    </select>
                                </div>

                                <div class="col-3">
                                    <label class="form-label" x-text="utils.translateForFieldLabel('LBL_ACTION')"></label>
                                    <select class="form-select" x-model="$store.actionEditor.selectedActionDefName" 
                                            @change="$store.actionEditor.onActionChange()"
                                            :disabled="$store.actionEditor.isEdit">
                                        <option value="" disabled selected>-- Selecciona --</option>
                                        <template x-for="def in $store.actionEditor.filteredActions" :key="def.name">
                                            <option :value="def.name" x-text="def.title"></option>
                                        </template>
                                    </select>
                                </div>
                                <template x-if="$store.actionEditor.definition">
                                    <div class="col-6 p-2 bg-info bg-opacity-10 border border-info rounded small d-flex align-items-center">
                                        <i class="suitepicon suitepicon-action-info me-2 flex-shrink-0"></i>
                                        <span x-text="$store.actionEditor.definition.description"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <template x-if="$store.actionEditor.action">
                        <div class="card">
                            <div class="card-header">
                                <span x-text="utils.translate('LBL_CONFIGURATION')"></span>
                            </div>
                            <div class="card-body">
                                <form>
                                    <div class="mb-4">
                                        <label class="form-label fw-bold" x-text="utils.translate('LBL_ACTION_NAME_CUSTOM')"></label>
                                        <input type="text" class="form-control" x-model="$store.actionEditor.action.text">
                                    </div>

                                    <hr class="my-4">

                                    <template x-for="paramDef in $store.actionEditor.definition.parameters" :key="paramDef.name">
                                        
                                        <div class="mb-3" x-data="{ 
                                            param: $store.actionEditor.action.parameters.find(p => p.name == paramDef.name) 
                                        }">
                                            
                                            <label class="form-label">
                                                <span x-text="paramDef.text"></span>
                                                <span x-show="paramDef.required" class="text-danger" title="Obligatori">*</span>
                                            </label>
                                            
                                            <div class="form-text mb-2" x-text="paramDef.description"></div>

                                            <template x-if="paramDef.type === 'value' && (!paramDef.dataType || ['text','integer','email'].includes(paramDef.dataType))">
                                                <input type="text" class="form-control" x-model="param.value">
                                            </template>

                                            <template x-if="paramDef.type === 'value' && paramDef.dataType === 'field_list'">
                                                <textarea class="form-control" rows="2" x-model="param.value" placeholder="Ex: Persona.nom, _detached.Bloc.camp"></textarea>
                                            </template>

                                            <template x-if="paramDef.type === 'value' && paramDef.dataType === 'select'">
                                                <select class="form-select" x-model="param.value">
                                                    <template x-for="opt in paramDef.options">
                                                        <option :value="opt.value" x-text="opt.text"></option>
                                                    </template>
                                                </select>
                                            </template>

                                            <template x-if="paramDef.type === 'dataBlock'">
                                                <select class="form-select" x-model="param.value"
                                                        @change="param.value_text = $event.target.options[$event.target.selectedIndex].text">
                                                    <option value="" disabled selected>-- Selecciona --</option>
                                                    <template x-for="block in $store.actionEditor.dataBlocksList" :key="block.id">
                                                        <option :value="block.id" x-text="block.text"></option>
                                                    </template>
                                                </select>
                                            </template>

                                            <template x-if="paramDef.type === 'field'">
                                                <select class="form-select" x-model="param.value"
                                                        @change="param.value_text = $event.target.options[$event.target.selectedIndex].text">
                                                    <option value="" disabled selected>-- Selecciona --</option>
                                                    <template x-for="field in $store.actionEditor.allFieldsList" :key="field.id">
                                                        <option :value="field.id" x-text="field.text"></option>
                                                    </template>
                                                </select>
                                            </template>
                                            
                                            <template x-if="paramDef.type === 'crmRecord'">
                                                <div class="input-group">
                                                    <span class="input-group-text" x-text="utils.translate('LBL_ID')"></span>
                                                    <input type="text" class="form-control" x-model="param.value" placeholder="Module|ID">
                                                    </div>
                                            </template>

                                            <template x-if="paramDef.type === 'optionSelector'">
                                                <div class="card p-3">
                                                    <div class="mb-2">
                                                        <label class="form-label small text-muted">Tipo de origen</label>
                                                        <select class="form-select" x-model="param.selectedOption" @change="param.value = ''">
                                                            <option value="" disabled selected>-- Selecciona --</option>
                                                            <template x-for="optDef in paramDef.selectorOptions" :key="optDef.name">
                                                                <option :value="optDef.name" x-text="optDef.text"></option>
                                                            </template>
                                                        </select>
                                                    </div>

                                                    <div x-data="{ get activeOpt() { return paramDef.selectorOptions.find(o => o.name == param.selectedOption); } }">
                                                        
                                                        <template x-if="activeOpt && activeOpt.resolvedType === 'empty'">
                                                            <div class="text-success small"><i class="suitepicon suitepicon-action-confirm"></i> Opci√≥n seleccionada.</div>
                                                        </template>

                                                        <template x-if="activeOpt && activeOpt.resolvedType === 'value'">
                                                            <input type="text" class="form-control" x-model="param.value" placeholder="Valor...">
                                                        </template>

                                                        <template x-if="activeOpt && activeOpt.resolvedType === 'dataBlock'">
                                                            <select class="form-select" x-model="param.value">
                                                                <option value="" disabled>-- Selecciona Bloque --</option>
                                                                <template x-for="block in $store.actionEditor.dataBlocksList" :key="block.id">
                                                                    <option :value="block.id" x-text="block.text"></option>
                                                                </template>
                                                            </select>
                                                        </template>

                                                        <template x-if="activeOpt && activeOpt.resolvedType === 'field'">
                                                            <select class="form-select" x-model="param.value">
                                                                <option value="" disabled>-- Selecciona Campo --</option>
                                                                <template x-for="field in $store.actionEditor.allFieldsList" :key="field.id">
                                                                    <option :value="field.id" x-text="field.text"></option>
                                                                </template>
                                                            </select>
                                                        </template>

                                                        <template x-if="activeOpt && activeOpt.resolvedType === 'crmRecord'">
                                                            <input type="text" class="form-control" x-model="param.value" placeholder="Module|ID">
                                                        </template>

                                                    </div>
                                                </div>
                                            </template>

                                        </div>
                                    </template>
                                    </form>
                            </div>
                        </div>
                    </template>

                </div>

                <div class="custom-modal-footer">
                    <button type="button" class="col-2 btn btn-secondary" @click="$store.actionEditor.close()" 
                            x-text="utils.translate('LBL_CANCEL_BUTTON_LABEL')"></button>
                    
                    <button type="button" class="col-2 btn btn-primary" 
                            @click="$store.actionEditor.saveChanges()" 
                            :disabled="!$store.actionEditor.action"
                            x-text="utils.translate('LBL_SAVE_BUTTON_LABEL')"></button>
                </div>
            </div>
        </div>
    </div>
</main>
